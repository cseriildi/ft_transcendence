input {
  tcp {
    port => 5000
    type => "docker"
  }

  udp {
    port => 5000
    type => "docker"
  }
}

filter {
  if [type] == "docker" {
    grok {
      match => { 
        "message" => "^<%{NONNEGINT:syslog_pri}>%{SYSLOGTIMESTAMP:syslog_timestamp} %{HOSTNAME:syslog_hostname} %{DATA:container_name}\[%{NUMBER:syslog_pid}\]: %{GREEDYDATA:log_message}$"
      }
      overwrite => [ "message" ]
    }

    if [container_name] {
      mutate {
        add_field => { "service" => "%{container_name}" }
      }
    }

    if [log_message] {
      json {
        source => "log_message"
        target => "app"
        skip_on_invalid_json => true
      }

      if [app] {
        translate {
          field => "[app][level]"
          destination => "[app][level_name]"
          dictionary => {
            "10" => "trace"
            "20" => "debug"
            "30" => "info"
            "40" => "warn"
            "50" => "error"
            "60" => "fatal"
          }
          fallback => "unknown"
        }

        if [app][time] {
          date {
            match => [ "[app][time]", "UNIX_MS" ]
            target => "@timestamp"
          }
        }

        if [app][req] {
          mutate {
            add_field => {
              "http_method" => "%{[app][req][method]}"
              "http_url" => "%{[app][req][url]}"
              "user_id" => "%{[app][req][userId]}"
              "client_ip" => "%{[app][req][remoteAddress]}"
            }
          }
        }

        if [app][res] {
          mutate {
            add_field => {
              "http_status_code" => "%{[app][res][statusCode]}"
            }
          }
        }

        if [app][reqId] {
          mutate {
            add_field => { "request_id" => "%{[app][reqId]}" }
          }
        }
      }
    }

    mutate {
      remove_field => [ "log", "stream", "attrs" ]
    }
  }

  mutate {
    add_field => {
      "environment" => "production"
      "application" => "ft_transcendence"
    }
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:elasticsearch:9200}"]
    index => "transcendence-logs-%{+YYYY.MM.dd}"

    document_id => "%{container_id}-%{+YYYY.MM.dd.HH.mm.ss.SSS}"
  }

}
