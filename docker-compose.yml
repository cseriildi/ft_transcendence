name: transcendence

services:
  databank:
    build:
      context: ./backend_database
    container_name: database
    env_file:
      - .env
    environment:
      # Docker container marker for auto-detection
      DOCKER_CONTAINER: "true"
      # Map .env variables to internal service variables
      PORT: ${DATABANK_PORT:-3000}
      HOST: ${DATABANK_HOST:-0.0.0.0}
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_PATH: ${DATABANK_DATABASE_PATH:-/app/data/database.db}
      # Public-facing URL configuration
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost}
      PUBLIC_PORT: ${PUBLIC_PORT:-}
      PUBLIC_PROTOCOL: ${PUBLIC_PROTOCOL:-http}
      # CORS configuration
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:4200}
    volumes:
      - ./backend_database/database:/app/data
      - ./backend_database/uploads:/app/uploads
    restart: unless-stopped
    networks:
      - transcendence

  backend:
    build:
      context: ./backend_gamelogic
    container_name: game
    env_file:
      - .env
    environment:
      DOCKER_CONTAINER: "true"
      PORT: ${GAMELOGIC_PORT:-3001}
      HOST: ${GAMELOGIC_HOST:-0.0.0.0}
      NODE_ENV: ${NODE_ENV:-production}
      # Public-facing URL configuration
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost}
      PUBLIC_PORT: ${PUBLIC_PORT:-}
    restart: unless-stopped
    networks:
      - transcendence

  frontend:
    build:
      context: ./frontend
    container_name: frontend
    env_file:
      - .env
    environment:
      PUBLIC_API_URL: ${PUBLIC_API_URL:-https://localhost:8443}
      PUBLIC_WS_URL: ${PUBLIC_WS_URL:-wss://localhost:8443/ws}
    restart: unless-stopped
    networks:
      - transcendence

  nginx:
    build:
      context: ./ops
    container_name: nginx-proxy
    env_file:
      - .env
    environment:
      NGINX_HTTPS_PORT: ${NGINX_HTTPS_PORT:-8443}
      NGINX_HTTP_PORT: ${NGINX_HTTP_PORT:-8080}
      NGINX_HOST: ${NGINX_HOST:-localhost}
      FRONTEND_PORT: ${FRONTEND_PORT:-4200}
      DATABANK_PORT: ${DATABANK_PORT:-3000}
      GAMELOGIC_PORT: ${GAMELOGIC_PORT:-3001}
      LIVECHAT_PORT: ${LIVECHAT_PORT:-3002}
    ports:
      - "${NGINX_HTTPS_PORT:-8443}:${NGINX_HTTPS_PORT:-8443}"
      - "${NGINX_HTTP_PORT:-8080}:${NGINX_HTTP_PORT:-8080}"
    volumes:
      - ./.certs:/etc/nginx/certs:ro
    depends_on:
      - frontend
      - databank
      - backend
    restart: unless-stopped
    networks:
      - transcendence

  live-chat:
    build:
      context: ./live-chat
    container_name: live-chat
    env_file:
      - .env
    environment:
      DOCKER_CONTAINER: "true"
      PORT: ${LIVECHAT_PORT:-3002}
      HOST: ${LIVECHAT_HOST:-0.0.0.0}
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_PATH: ${LIVECHAT_DATABASE_PATH:-/app/data/database.db}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://databank:3000}
      # CORS configuration
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:4200,http://localhost:8080}
    volumes:
      - ./live-chat/data:/app/data
    depends_on:
      - databank
    restart: unless-stopped
    networks:
      - transcendence

volumes:
  databank-data:

networks:
  transcendence:
    driver: bridge
